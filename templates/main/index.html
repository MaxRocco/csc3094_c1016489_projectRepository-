{% extends "base.html" %}

{% block content %}

    <h1 class="title">Reflective Journals Page</h1>


    <style>

        #friend-functionality {
            position: absolute;
            top: 8px;
            left: 16px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
            color: #333;
            width: 300px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }


        .post {
            margin: 20px 0px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
            color: #333;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 8px 16px;
            margin: 5px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }
    </style>

    <br>
    <br>
    <br>
    <br>
    <br>

    <div id="friend-functionality">
        {% if current_user.is_authenticated %}
            <h2>Welcome, {{ current_user.firstname }}!</h2>


            <div>
                <h3><strong>Your Friend Requests</strong></h3>
                {% for request in current_user.received_friendships.filter_by(status='pending').all() %}
                    <p>{{ request.requester.firstname }} wants to be your friend</p>
                    <form method="post" action="{{ url_for('users.accept_friend_request', request_id=request.id) }}">
                        <button type="submit">Accept</button>
                    </form>
                    <form method="post" action="{{ url_for('users.decline_friend_request', request_id=request.id) }}">
                        <button type="submit">Decline</button>
                    </form>
                {% else %}
                    <p>You currently have no incoming friend requests</p>
                {% endfor %}
            </div>

            <br>

            <div>
                <h4>Find Users:</h4>
                <form method="get" action="{{ url_for('users.search_users') }}">
                    <input type="text" name="query" placeholder="Search for friends by email"
                           style="padding: 5px; margin: 5px 0; width: 90%;">
                    <button type="submit">Search</button>
                </form>
            </div>

            {% if search_results %}
                <h5>Search Results: </h5>
                {% for user in search_results %}
                    <p>{{ user.firstname }} {{ user.lastname }} - {{ user.email }}</p>
                    {% if user.id != current_user.id %}
                        <form method="post" action="{{ url_for('users.send_friend_request', user_id=user.id) }}">
                            <button type="submit">Send Friend Request</button>
                        </form>
                    {% endif %}
                {% else %}
                    <p>No users found with this email</p>
                {% endfor %}
            {% endif %}
        {% endif %}
    </div>

    <h3><strong>Sent Friend Requests</strong></h3>
    <br>
    {% for request in sent_requests %}
        <p>To: {{ request.requested.email }} - Status: Pending</p>
    {% else %}
        <p>You have not sent any active or pending friend requests</p>
        <br>
    {% endfor %}

    <h3><strong>Your Friends</strong></h3>
    <br>
    {% for friendship in confirmed_friendships %}
        <p>
            Friend: {{ friendship.requester.email if friendship.requested_id == current_user.id else friendship.requested.email }}</p>
    {% else %}
        <p>You currently have no confirmed friendships</p>
        <br>
    {% endfor %}
    </div>

    {% if current_user.is_authenticated %}
        <div>
            <h6>Your Reflective Posts</h6>
            {% if posts %}
                {% for post in posts %}
                    <div class="post">
                        <h4>{{ post.title }}</h4>
                        <p>{{ post.body }}</p>
                        <small>Posted on {{ post.dateCreated.strftime('%Y-%m-%d at %H:%M') }}</small>
                    </div>
                {% endfor %}
            {% else %}
                <p>You have not made any reflective posts yet. Go to the <a
                        href="{{ url_for('users.mealTree') }}" target=" _blank">Meal Progression Tree</a> to complete a
                    meal and make your first reflective post!
                </p>
            {% endif %}
        </div>
    {% endif %}

{% endblock %}
