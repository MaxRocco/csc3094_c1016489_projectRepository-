{% extends "base.html" %}

{% block content %}


    {% if current_user.is_anonymous %}
        <h1 class="title">Please <a href="{{ url_for('users.login') }}" target=" _blank"><strong>login</strong></a> or
            <a
                    href="{{ url_for('users.register') }}" target=" _blank"><strong>register</strong></a> an account to
            access
            the application!</h1>
    {% endif %}

    {% if current_user.is_authenticated %}
        <h1 class="title">Reflective Journals Page</h1>
    {% endif %}

    <style>

        #friend-functionality {
            position: absolute;
            top: 8px;
            left: 16px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
            color: #333;
            width: 300px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }


        .post {
            margin: 20px 0px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
            color: #333;
            width: 600px;
            word-wrap: break-word;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 8px 16px;
            margin: 5px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }
    </style>

    <br>
    <br>
    <br>
    <br>
    <br>

    {% if current_user.is_authenticated %}
        <div id="friend-functionality">
        <h2>Welcome, {{ current_user.firstname }}!</h2>


        <div>
            <h3><strong>Your Friend Requests</strong></h3>
            {% for request in current_user.received_friendships.filter_by(status='pending').all() %}
                <p>{{ request.requester.firstname }} wants to be your friend</p>
                <form method="post" action="{{ url_for('users.accept_friend_request', request_id=request.id) }}">
                    <button type="submit">Accept</button>
                </form>
                <form method="post" action="{{ url_for('users.decline_friend_request', request_id=request.id) }}">
                    <button type="submit">Decline</button>
                </form>
            {% else %}
                <p>You currently have no incoming friend requests</p>
            {% endfor %}
        </div>

        <br>

        <div>
            <h4>Find Users:</h4>
            <form method="get" action="{{ url_for('users.search_users') }}">
                <input type="text" name="query" placeholder="Enter a user email to search for friends"
                       style="padding: 5px; margin: 5px 0; width: 90%;">
                <button type="submit">Search</button>
            </form>
        </div>

        {% if search_results %}
            <h5>Search Results: </h5>
            {% for user in search_results %}
                <p>{{ user.firstname }} {{ user.lastname }} - {{ user.email }}</p>
                {% if user.id != current_user.id %}
                    <form method="post" action="{{ url_for('users.send_friend_request', user_id=user.id) }}">
                        <button type="submit">Send Friend Request</button>
                    </form>
                {% endif %}
            {% else %}
                <p>No users have been found using this email address</p>
            {% endfor %}
        {% endif %}
    {% endif %}
</div>

    {% if current_user.is_authenticated %}
        <h3><strong>Sent Friend Requests</strong></h3>
        <br>
        {% for request in sent_requests %}
            <p>To: {{ request.requested.email }} - Status: Pending</p>
        {% else %}
            <p>You have not sent any active or pending friend requests</p>
            <br>
        {% endfor %}

        <h3><strong>Your Friends</strong></h3>
        <br>
        {% for friendship in confirmed_friendships %}
            <p>
                {{ friendship.requester.email if friendship.requested_id == current_user.id else friendship.requested.email }}</p>
        {% else %}
            <p>You currently have no confirmed friendships</p>
            <br>
        {% endfor %}
        </div>
    {% endif %}

    {% if current_user.is_authenticated %}
        <div>
            <h6><strong>Reflective Posts made by you or your friends</strong></h6>
            <br>
            {% if posts %}
                {% for post in posts %}
                    <div class="post">
                        <h4>{{ post.title }}</h4>
                        <p>{{ post.body }}</p>
                        <small>Posted on {{ post.dateCreated.strftime('%Y-%m-%d at %H:%M') }}</small>
                        <small>By: {{ post.user.firstname }} {{ post.user.lastname }}</small>
                    </div>
                {% endfor %}
            {% else %}
                <br>
                <p>You or your friends have not made any reflective posts yet. Go to the <a
                        href="{{ url_for('users.mealTree') }}" target=" _blank"><strong>Meal Progression
                    Tree</strong></a> to complete a
                    meal to make your first reflective post!
                </p>
            {% endif %}
        </div>
    {% endif %}

{% endblock %}
